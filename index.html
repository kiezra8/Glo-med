<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glo-Med Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (Compat for simple script usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAdiAf0Ni1wsm00PMiT1-agSmgPxEkvswo",
            authDomain: "glo-med.firebaseapp.com",
            projectId: "glo-med",
            storageBucket: "glo-med.firebasestorage.app",
            messagingSenderId: "259320794812",
            appId: "1:259320794812:web:179fbcd9710d6b1e9b4ab9",
            measurementId: "G-XQXF0ZBRBV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Helper to mimic Supabase-like syntax for easier refactoring
        window.db = db;
        window.auth = auth;
        window.storage = storage;
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* PharmEasy Clean Card Style */
        .pharmeasy-card {
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .pharmeasy-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* PharmEasy Primary Colors */
        .bg-pharmeasy-teal {
            background: #10847E;
        }

        .text-pharmeasy-teal {
            color: #10847E;
        }

        .bg-pharmeasy-orange {
            background: #FF6F61;
        }

        .text-pharmeasy-orange {
            color: #FF6F61;
        }

        /* Clean Header Style */
        .pharmeasy-header {
            background: #FFFFFF;
            border-bottom: 1px solid #E8E8E8;
        }

        /* Search Bar */
        .pharmeasy-search {
            background: #F7F8FA;
            border: 1px solid #E8E8E8;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .pharmeasy-search:focus {
            outline: none;
            border-color: #10847E;
            background: #FFFFFF;
        }

        /* Category Cards */
        .category-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .category-card:hover .category-image {
            transform: scale(1.05);
        }

        /* Product Cards */
        .product-card {
            background: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .product-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        /* Discount Badge */
        .discount-badge {
            background: #FF6F61;
            color: #FFFFFF;
            font-size: 10px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Add to Cart Button */
        .pharmeasy-btn {
            background: #10847E;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pharmeasy-btn:hover {
            background: #0D6B66;
            transform: translateY(-1px);
        }

        .pharmeasy-btn:active {
            transform: translateY(0);
        }

        /* Offer Cards */
        .offer-card {
            background: linear-gradient(135deg, #FF6F61 0%, #FF9068 100%);
            border-radius: 12px;
            color: #FFFFFF;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(255, 111, 97, 0.3);
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: #FFFFFF;
            border-top: 1px solid #E8E8E8;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Cart Badge */
        .cart-badge {
            background: #10847E;
            color: #FFFFFF;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Rating Stars */
        .rating-star {
            color: #FFA500;
        }

        /* Price Styling */
        .price-current {
            color: #1A1A1A;
            font-weight: 700;
            font-size: 16px;
        }

        .price-original {
            color: #999999;
            font-size: 13px;
            text-decoration: line-through;
        }

        /* Clean Typography */
        .section-title {
            color: #1A1A1A;
            font-weight: 700;
            font-size: 18px;
        }

        .category-title {
            color: #1A1A1A;
            font-weight: 600;
            font-size: 14px;
        }

        .product-name {
            color: #333333;
            font-weight: 500;
            font-size: 13px;
            line-height: 1.3;
        }

        .company-name {
            color: #666666;
            font-size: 11px;
        }

        /* Hero Carousel Styles */
        .hero-carousel {
            position: relative;
            height: 180px;
            overflow: hidden;
            border-radius: 16px;
        }

        .hero-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hero-slide.active {
            opacity: 1;
            transform: translateY(0);
        }

        .hero-slide.exit {
            opacity: 0;
            transform: translateY(-100%);
        }

        /* Carousel Indicators */
        .carousel-indicators {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .indicator.active {
            width: 24px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Gradient Overlays for Slides */
        .gradient-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1));
        }

        /* NEW SHEIN UI STYLES */
        .nav-item {
            color: #999999;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex: 1;
            padding: 8px 0;
            cursor: pointer;
        }

        .nav-item.active {
            color: #000000;
            font-weight: 600;
        }

        .chat-bubble-mine {
            background: #dcf8c6;
            color: #000;
            border-radius: 7px 0 7px 7px;
        }

        .chat-bubble-theirs {
            background: #ffffff;
            color: #000;
            border: 1px solid #f0f0f0;
            border-radius: 0 7px 7px 7px;
        }
    </style>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10847E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body class="flex justify-center min-h-screen">
    <div id="app" class="w-full max-w-md min-h-screen relative flex flex-col bg-white">
        <header id="header" class="sticky top-0 z-50 bg-white border-b border-gray-100"></header>
        <main id="main-content" class="flex-1 overflow-y-auto pb-20 hide-scrollbar bg-white"></main>
        <nav id="bottom-nav" class="fixed bottom-0 w-full max-w-md bottom-nav flex justify-around py-3 z-50 px-2">
        </nav>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 id="edit-modal-title" class="font-bold text-gray-900">Edit Item</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div id="edit-modal-content" class="p-4 space-y-3">
                <!-- Dynamic Content -->
            </div>
            <div class="px-4 py-3 bg-gray-50 flex gap-3">
                <button onclick="closeEditModal()"
                    class="flex-1 pharmeasy-btn bg-gray-200 text-gray-700 hover:bg-gray-300">Cancel</button>
                <button id="edit-save-btn" class="flex-1 pharmeasy-btn">Save Changes</button>
            </div>
        </div>
    </div>
    <script>
        window.onerror = function (msg, url, line) {
            alert("Global Error: " + msg + "\nLine: " + line);
        };
        // Use the db initialized in the module above
        // If strict module isolation is an issue, we can move the main logic into type="module" or use the window globals set above.
        // For simplicity in this single-file setup, we rely on the window globals or standard script execution order.

        const drugClasses = [
            "Analgesics", "Antipyretics", "Antibiotics", "Antivirals", "Antifungals",
            "Antimalarials", "Anthelmintics", "Antihistamines", "Antacids", "Anti-ulcer drugs",
            "Antihypertensives", "Antidiabetic drugs", "Anticonvulsants", "Antidepressants",
            "Antianxiety drugs", "Antipsychotics", "Bronchodilators", "Steroids (corticosteroids)",
            "Diuretics", "Local anesthetics", "General anesthetics", "Chemotherapy drugs",
            "Immunosuppressants", "Vaccines", "Hormonal drugs", "Anticoagulants",
            "Antiplatelets", "Lipid-lowering drugs", "Muscle relaxants", "Antiemetics",
            "Expectorants", "Cough suppressants"
        ];

        const drugSubcategories = drugClasses.map((d, i) => ({
            name: d,
            image: [
                'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=400&h=400&fit=crop',
                'https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=400&h=400&fit=crop',
                'https://images.unsplash.com/photo-1587854692152-cbe660dbde88?w=400&h=400&fit=crop',
                'https://images.unsplash.com/photo-1585435557343-3b092031a831?w=400&h=400&fit=crop'
            ][i % 4],
            products: [{
                name: `${d} Product`,
                company: 'Glo-Med',
                price: 'UGX 25,000',
                originalPrice: 'UGX 30,000',
                unit: 'Pack',
                discount: '10% OFF',
                rating: 4.5,
                reviews: 100 + i * 5,
                image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=400&h=400&fit=crop'
            }]
        }));

        const consumableList = [
            { name: "Syringes", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Needles", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "IV cannulas", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "IV giving sets", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Gloves (sterile and non-sterile)", image: "https://images.unsplash.com/photo-1584473457409-ae5c91d7a8cc?w=400&h=400&fit=crop" },
            { name: "Face masks", image: "https://images.unsplash.com/photo-1585435557343-3b092031a831?w=400&h=400&fit=crop" },
            { name: "Surgical masks", image: "https://images.unsplash.com/photo-1585435557343-3b092031a831?w=400&h=400&fit=crop" },
            { name: "N95 masks", image: "https://images.unsplash.com/photo-1585435557343-3b092031a831?w=400&h=400&fit=crop" },
            { name: "Bandages", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Gauze swabs", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Cotton wool", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Plasters", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Surgical blades", image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=400&h=400&fit=crop" },
            { name: "Suture materials", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Urine bags", image: "https://images.unsplash.com/photo-1584305556252-d3e43d6d7429?w=400&h=400&fit=crop" },
            { name: "Specimen bottles", image: "https://images.unsplash.com/photo-1583911860205-72f8ac8ddcbe?w=400&h=400&fit=crop" },
            { name: "Alcohol swabs", image: "https://images.unsplash.com/photo-1584305556252-d3e43d6d7429?w=400&h=400&fit=crop" },
            { name: "Disinfectant wipes", image: "https://images.unsplash.com/photo-1584305556252-d3e43d6d7429?w=400&h=400&fit=crop" },
            { name: "Test strips (glucose, urine)", image: "https://images.unsplash.com/photo-1583911860205-72f8ac8ddcbe?w=400&h=400&fit=crop" },
            { name: "Catheters (foley, feeding)", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Suction catheters", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Syringe filters", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Blood collection tubes", image: "https://images.unsplash.com/photo-1583911860205-72f8ac8ddcbe?w=400&h=400&fit=crop" },
            { name: "Lancets", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "Disposable gowns", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Caps and shoe covers", image: "https://images.unsplash.com/photo-1584473457409-ae5c91d7a8cc?w=400&h=400&fit=crop" },
            { name: "Thermal paper (ultrasound/ECG)", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Disposable drapes", image: "https://images.unsplash.com/photo-1584473457409-ae5c91d7a8cc?w=400&h=400&fit=crop" },
            { name: "Oxygen nasal cannulas", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Nebulizer masks", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Hand sanitizers", image: "https://images.unsplash.com/photo-1584305556252-d3e43d6d7429?w=400&h=400&fit=crop" },
            { name: "Wound dressings", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Cannula fixators", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Tape (micropore, surgical)", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Airway adjuncts (OPA, NPA)", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" }
        ];

        const equipmentList = [
            { name: "Blood pressure machine (manual and digital)", image: "https://images.unsplash.com/photo-1623869151528-9104c2780838?w=400&h=400&fit=crop" },
            { name: "Stethoscope", image: "https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=400&h=400&fit=crop" },
            { name: "Thermometer (digital, infrared)", image: "https://images.unsplash.com/photo-1584515933487-779824d29309?w=400&h=400&fit=crop" },
            { name: "Oxygen concentrator", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Pulse oximeter", image: "https://images.unsplash.com/photo-1603721203474-c0b0e4329cf0?w=400&h=400&fit=crop" },
            { name: "Glucometer", image: "https://images.unsplash.com/photo-1603721203474-c0b0e4329cf0?w=400&h=400&fit=crop" },
            { name: "Nebulizer", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Suction machine", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "ECG machine", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "Ultrasound machine", image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=400&h=400&fit=crop" },
            { name: "Defibrillator", image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=400&h=400&fit=crop" },
            { name: "Autoclave", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "Weighing scale (adult, infant)", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Examination light", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "Oxygen cylinder", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Spirometer", image: "https://images.unsplash.com/photo-1615486511484-92e172cc4fe0?w=400&h=400&fit=crop" },
            { name: "Fetal doppler", image: "https://images.unsplash.com/photo-1603721203474-c0b0e4329cf0?w=400&h=400&fit=crop" },
            { name: "Laboratory centrifuge", image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=400&h=400&fit=crop" },
            { name: "Microscope", image: "https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?w=400&h=400&fit=crop" },
            { name: "Infusion pump", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "Syringe pump", image: "https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=400&h=400&fit=crop" },
            { name: "Patient monitor", image: "https://images.unsplash.com/photo-1615486511484-92e172cc4fe0?w=400&h=400&fit=crop" },
            { name: "CPAP/BiPAP machine", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Sterilizer", image: "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400&h=400&fit=crop" },
            { name: "ENT diagnostic set", image: "https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=400&h=400&fit=crop" },
            { name: "Ophthalmoscope", image: "https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=400&h=400&fit=crop" },
            { name: "Otoscope", image: "https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=400&h=400&fit=crop" },
            { name: "Laryngoscope", image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=400&h=400&fit=crop" },
            { name: "Ambu bag (BVM)", image: "https://images.unsplash.com/photo-1581594549595-35f6edc7b762?w=400&h=400&fit=crop" },
            { name: "Wheelchair", image: "https://images.unsplash.com/photo-1576765607924-3f7b8410a787?w=400&h=400&fit=crop" },
            { name: "Hospital stretcher", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" }
        ];

        const furnitureList = [
            { name: "Hospital beds", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Examination couch", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Bedside lockers", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Overbed tables", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Medical trolleys", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Drug trolleys", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Instrument trolleys", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Dressing trolleys", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Doctorâ€™s stool", image: "https://images.unsplash.com/photo-1606811971618-4486d14f3f72?w=400&h=400&fit=crop" },
            { name: "Patient chairs", image: "https://images.unsplash.com/photo-1606811971618-4486d14f3f72?w=400&h=400&fit=crop" },
            { name: "Waiting room chairs", image: "https://images.unsplash.com/photo-1576765607924-3f7b8410a787?w=400&h=400&fit=crop" },
            { name: "IV poles", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" },
            { name: "Cupboards (medicine cabinets)", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Shelves for storage", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Delivery bed", image: "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop" },
            { name: "Baby cot/incubator stand", image: "https://images.unsplash.com/photo-1555529733-0e670560f7e1?w=400&h=400&fit=crop" },
            { name: "Partition screens", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Crash cart", image: "https://images.unsplash.com/photo-1516574187841-693083f6991f?w=400&h=400&fit=crop" },
            { name: "Reception desk", image: "https://images.unsplash.com/photo-1594824476967-48c8b964273f?w=400&h=400&fit=crop" },
            { name: "Dental chair", image: "https://images.unsplash.com/photo-1606811971618-4486d14f3f72?w=400&h=400&fit=crop" },
            { name: "Waste bins (color coded)", image: "https://images.unsplash.com/photo-1603398938378-e54eab446dde?w=400&h=400&fit=crop" }
        ];

        const createSubcategories = (list, baseImage) => list.map((item, i) => {
            const name = typeof item === 'string' ? item : item.name;
            const image = typeof item === 'string' ? (baseImage || 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=400&h=400&fit=crop') : item.image;

            return {
                name: name,
                image: image,
                products: [{
                    name: `${name} Standard`,
                    company: 'Glo-Med',
                    price: 'UGX 50,000',
                    originalPrice: 'UGX 60,000',
                    unit: 'Unit',
                    discount: '15% OFF',
                    rating: 4.5,
                    reviews: 120,
                    image: image
                }]
            };
        });

        let categories = [
            {
                iconName: 'pill', name: 'Drugs', color: 'bg-blue-500',
                image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=400&h=400&fit=crop',
                subcategories: drugSubcategories
            },
            {
                iconName: 'package', name: 'Consumables', color: 'bg-orange-500',
                image: 'https://iororwxhmiiqlq5p.leadongcdn.com/cloud/pnBplKplRllSqirjnqlrj/weixintupian_20250526144752.png',
                subcategories: createSubcategories(consumableList, 'https://images.unsplash.com/photo-1584473457409-ae5c91d7a8cc?w=400&h=400&fit=crop')
            },
            {
                iconName: 'stethoscope', name: 'Medical Equipment', color: 'bg-green-500',
                image: 'https://images.unsplash.com/photo-1615486511484-92e172cc4fe0?w=400&h=400&fit=crop',
                subcategories: createSubcategories(equipmentList, 'https://images.unsplash.com/photo-1615486511484-92e172cc4fe0?w=400&h=400&fit=crop')
            },
            {
                iconName: 'armchair', name: 'Medical Furniture', color: 'bg-purple-500',
                image: 'https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop',
                subcategories: createSubcategories(furnitureList, 'https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400&h=400&fit=crop')
            }
        ];

        const heroSlides = [
            {
                title: 'Fast Delivery',
                subtitle: 'Get your medical supplies delivered',
                description: 'Within 2-4 hours',
                image: 'https://images.unsplash.com/photo-1587293852726-70cdb56c2866?w=800&fit=crop', // Delivery drone/bike
                gradient: 'linear-gradient(135deg, #10847E 0%, #0D6B66 100%)'
            },
            {
                title: 'New Arrivals',
                subtitle: 'Latest drugs on the market',
                description: 'FDA approved medications',
                image: 'https://images.unsplash.com/photo-1631549916768-4119b2e5f926?w=800&fit=crop', // Pharma shelf
                gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
            },
            {
                title: 'Special Deals',
                subtitle: 'Up to 25% OFF on bulk orders',
                description: 'Limited time offers',
                image: 'https://images.unsplash.com/photo-1607619056574-7b8d3ee536b2?w=800&fit=crop', // Discounts
                gradient: 'linear-gradient(135deg, #FF6F61 0%, #FF9068 100%)'
            },
            {
                title: 'Quality Assured',
                subtitle: 'Certified medical equipment',
                description: '100% authentic products',
                image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=800&fit=crop', // Quality seal/lab
                gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
            },
            {
                title: '24/7 Support',
                subtitle: 'Expert medical consultation',
                description: 'Always here to help',
                image: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=800&fit=crop', // Support/Doctor
                gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
            }
        ];

        let currentUser = null;

        let state = {
            page: 'home',
            selectedCategory: null,
            selectedSubcategory: null,
            cart: [], // items: { product, quantity }
            currentSlide: 0,
            activeChat: null,
            searchQuery: ''
        };

        // News Data Global
        let newsPosts = [
            {
                type: 'image',
                title: 'New Anti-Malarial: Pyramax',
                description: 'Pyramax is now available in stock. Highly effective against resistant malaria strains. Recommended for both adults and children.',
                image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=800&h=600&fit=crop',
                views: '1.2k',
                time: '2 hours ago'
            },
            {
                type: 'image',
                title: 'Advanced Digital Stethoscopes',
                description: 'Experience crystal clear heart and lung sounds with our new Littmann digital stethoscopes. Bluetooth compatible for recording.',
                image: 'https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=800&h=600&fit=crop',
                views: '856',
                time: '5 hours ago'
            },
            {
                type: 'image',
                title: 'Portable Ultrasound Scanners',
                description: 'Handheld ultrasound devices for quick bedside diagnostics. Connects directly to your smartphone or tablet.',
                image: 'https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=800&h=600&fit=crop',
                views: '2.4k',
                time: '1 day ago'
            },
            {
                type: 'image',
                title: 'Insulin Glargine Pens',
                description: 'Long-acting insulin pens for better diabetes management. Easy to use and less painful injection mechanism.',
                image: 'https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=800&h=600&fit=crop',
                views: '3.1k',
                time: '1 day ago'
            },
            {
                type: 'image',
                title: 'Automated BP Monitors',
                description: 'Omron Series 10 fully automated blood pressure monitors. clinically validated for accuracy.',
                image: 'https://images.unsplash.com/photo-1603721203474-c0b0e4329cf0?w=800&h=600&fit=crop',
                views: '5k',
                time: '2 days ago'
            },
            {
                type: 'image',
                title: 'Pulse Oximeters',
                description: 'High-precision fingertip pulse oximeters. Essential for monitoring oxygen saturation levels at home or clinic.',
                image: 'https://images.unsplash.com/photo-1631549916768-4119b2e5f926?w=800&h=600&fit=crop',
                views: '900',
                time: '2 days ago'
            },
            {
                type: 'image',
                title: 'Surgical Suture Sets',
                description: 'Complete range of sterile surgical sutures (Vicryl, Nylon, Silk) now back in stock for hospital orders.',
                image: 'https://images.unsplash.com/photo-1579154204845-72d0e10a4c0f?w=800&h=600&fit=crop',
                views: '1.5k',
                time: '3 days ago'
            }
        ];

        // Chat Data Mock
        // Create a reactive chats array
        let chats = [];
        let orders = [];
        let flashDealProducts = [];
        let messagesUnsubscribe = null;
        let chatsUnsubscribe = null;

        // Admin List (Simple hardcoded for now)
        const adminEmails = ['israelezrakisakye@gmail.com', 'admin2@example.com'];

        function subscribeToChats() {
            if (chatsUnsubscribe) {
                chatsUnsubscribe();
                chatsUnsubscribe = null;
            }

            if (!currentUser) return;

            // Fetch initial not needed if we subscribe immediately, but kept for logic structure
            // fetchChats(); 

            const isUserAdmin = currentUser.role === 'admin';
            let query = db.collection('chats');

            if (isUserAdmin) {
                // query = query.orderBy('last_message_time', 'desc'); 
                // Removed server-side sort to avoid index errors for now
            } else {
                query = query.where('user_id', '==', currentUser.uid);
                // .orderBy('last_message_time', 'desc');
            }

            chatsUnsubscribe = query.onSnapshot(snapshot => {
                const newChats = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return {
                        id: doc.id,
                        userId: d.user_id,
                        userName: d.user_name,
                        lastMessage: d.last_message,
                        lastMessageTime: d.last_message_time ? new Date(d.last_message_time) : null,
                        unread: isUserAdmin ? (d.unread_admin || 0) : (d.unread_client || 0),
                        time: d.last_message_time ? new Date(d.last_message_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''
                    };
                });

                // Sort client-side
                chats = newChats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));

                // Toast Logic
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified' || change.type === 'added') {
                        const chat = change.doc.data();
                        // Skip initial load
                        // ... logic omitted for brevity, focusing on data sync
                    }
                });

                chats = newChats;
                if (state.page === 'chat') updateUI();
            }, error => {
                console.error("Chat Listener Error:", error);
            });
        }

        async function fetchChats() {
            // No-op, using real-time listener
        }


        let carouselInterval;

        // Populate Products to ~50 per subcategory
        function populateProducts() {
            categories.forEach(cat => {
                cat.subcategories.forEach(sub => {
                    // Ensure existing have IDs
                    sub.products.forEach(p => { if (!p.id) p.id = Math.random().toString(36).substr(2, 9); });

                    const originals = [...sub.products];
                    while (sub.products.length < 50) {
                        const template = originals[Math.floor(Math.random() * originals.length)];
                        sub.products.push({
                            ...template,
                            id: Math.random().toString(36).substr(2, 9),
                            name: `${template.name} (Batch ${Math.floor(Math.random() * 100)})`,
                            reviews: Math.floor(Math.random() * 500),
                            rating: (4 + Math.random()).toFixed(1)
                        });
                    }
                });
            });
        }
        // populateProducts(); // Moved to loadData or fallback


        async function loadData() {
            try {
                // Fetch Categories
                const catSnap = await db.collection('categories').orderBy('id').get();
                const cats = catSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (cats.length === 0) {
                    console.log("No categories in DB, using hardcoded");
                    populateProducts(); // This populates local state. We should also seed DB if needed.
                    // Automatically seed if empty to ensure data exists
                    seedDatabase();
                    updateUI();
                    return;
                }

                // Fetch Subcategories
                const subSnap = await db.collection('subcategories').get();
                const subs = subSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Fetch Products
                const prodSnap = await db.collection('products').get();
                const prods = prodSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Fetch Orders (if admin)
                let ords = [];
                if (isAdmin) {
                    const ordSnap = await db.collection('orders').orderBy('created_at', 'desc').get();
                    ords = ordSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    orders = ords;
                }

                // Rebuild tree
                categories = cats.map(c => ({
                    id: c.id,
                    name: c.name,
                    image: c.image,
                    color: c.color,
                    iconName: c.icon_name,
                    subcategories: subs.filter(s => s.category_id === c.id).map(s => ({
                        id: s.id,
                        name: s.name,
                        image: s.image,
                        products: prods.filter(p => p.subcategory_id === s.id).map(p => ({
                            id: p.id,
                            name: p.name,
                            company: p.company,
                            price: p.price,
                            originalPrice: p.original_price,
                            unit: p.unit,
                            rating: p.rating,
                            reviews: p.reviews,
                            image: p.image,
                            discount: p.discount
                        }))
                    }))
                }));

                // Populate Flash/Trending Products
                const allProds = categories.flatMap(c => c.subcategories.flatMap(s => s.products));
                // Prefer discounted items for "Trending", otherwise take random
                let trending = allProds.filter(p => p.discount || p.originalPrice);
                if (trending.length < 4) {
                    const others = allProds.filter(p => !p.discount && !p.originalPrice);
                    trending = [...trending, ...others].slice(0, 8);
                }
                flashDealProducts = trending;

                console.log("Loaded data from Firestore:", categories.length);
                updateUI();

            } catch (e) {
                console.error("Load Data Error", e);
                populateProducts();
                updateUI();
            }
        }

        // Admin Edit Logic
        let currentEdit = null;

        async function handleFileUpload(input, targetId) {
            const file = input.files[0];
            if (!file) return;

            const msgEl = document.getElementById(`upload-msg-${targetId.replace('edit-', '')}`);
            if (msgEl) msgEl.innerText = "Uploading...";

            try {
                const fileName = `uploads/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const ref = storage.ref(fileName);

                // Upload
                await ref.put(file);

                // Get URL
                const publicUrl = await ref.getDownloadURL();

                document.getElementById(targetId).value = publicUrl;
                if (msgEl) {
                    msgEl.innerText = "Upload Complete!";
                    msgEl.className = "text-[10px] text-green-600 mt-1 font-bold";
                }

            } catch (e) {
                console.error("Upload failed", e);
                if (msgEl) {
                    msgEl.innerText = "Upload Failed. Ensure Storage rules allow write.";
                    msgEl.className = "text-[10px] text-red-600 mt-1";
                    throw e;
                }
            }

            async function openEditModal(mode, type, idOrParentId) {
                const modal = document.getElementById('edit-modal');
                const title = document.getElementById('edit-modal-title');
                const content = document.getElementById('edit-modal-content');
                const saveBtn = document.getElementById('edit-save-btn');

                modal.classList.remove('hidden');

                // Set context
                currentEdit = { mode, type, id: idOrParentId }; // idOrParentId might be parentID for create

                let item = {};
                let fields = [];

                if (type === 'category') {
                    title.innerText = mode === 'create' ? 'Add New Category' : 'Edit Category';
                    fields = [
                        { label: 'Name', key: 'name', type: 'text' },
                        { label: 'Image URL', key: 'image', type: 'text' }
                    ];
                    if (mode === 'edit') {
                        item = categories[idOrParentId] || categories.find(c => c.id === idOrParentId);
                        if (item) currentEdit.item = item;
                    }
                } else if (type === 'subcategory') {
                    title.innerText = mode === 'create' ? 'Add New Collection' : 'Edit Collection';
                    fields = [
                        { label: 'Name', key: 'name', type: 'text' },
                        { label: 'Image URL', key: 'image', type: 'text' }
                    ];
                    if (mode === 'edit') {
                        // logic to find subcat
                        for (let c of categories) {
                            let s = c.subcategories.find(sub => sub.id === idOrParentId) || c.subcategories[idOrParentId];
                            if (s) { item = s; currentEdit.item = s; break; }
                        }
                    }
                } else if (type === 'product') {
                    title.innerText = mode === 'create' ? 'Add New Product' : 'Edit Product';
                    fields = [
                        { label: 'Name', key: 'name', type: 'text' },
                        { label: 'Company', key: 'company', type: 'text' },
                        { label: 'Price', key: 'price', type: 'text' },
                        { label: 'Unit', key: 'unit', type: 'text' },
                        { label: 'Image URL', key: 'image', type: 'text' }
                    ];
                    if (mode === 'edit') {
                        item = getProductById(idOrParentId);
                        if (item) currentEdit.item = item;
                    }
                } else if (type === 'news') {
                    title.innerText = mode === 'create' ? 'Post News' : 'Edit Post';
                    fields = [
                        { label: 'Title', key: 'title', type: 'text' },
                        { label: 'Description', key: 'description', type: 'text' },
                        { label: 'Image URL', key: 'image', type: 'text' }
                    ];
                    if (mode === 'edit') {
                        item = newsPosts[idOrParentId];
                        if (item) currentEdit.item = item;
                    }
                }

                content.innerHTML = fields.map(f => `
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-700 mb-1">${f.label}</label>
                    <input type="${f.type}" id="edit-${f.key}" value="${item && item[f.key] ? item[f.key] : ''}" class="w-full pharmeasy-search px-3 py-2 text-sm" placeholder="Enter ${f.label}">
                    ${f.key === 'image' ? `
                    <div class="mt-2 p-2 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <label class="block text-[10px] text-gray-500 mb-1 font-medium">Or upload image</label>
                        <input type="file" id="edit-file-input" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[10px] file:font-semibold file:bg-pharmeasy-teal file:text-white hover:file:bg-teal-600"/>
                    </div>` : ''}
                </div>
            `).join('');

                saveBtn.innerText = mode === 'create' ? 'Create' : 'Save Changes';

                // Override onclick to handle upload + save in one go
                saveBtn.onclick = async () => {
                    const updates = {};
                    fields.forEach(f => {
                        const el = document.getElementById(`edit-${f.key}`);
                        if (el) updates[f.key] = el.value;
                    });

                    // Check for file upload
                    const fileInput = document.getElementById('edit-file-input');
                    if (fileInput && fileInput.files.length > 0) {
                        saveBtn.innerText = "Uploading...";
                        saveBtn.disabled = true;
                        try {
                            const file = fileInput.files[0];
                            const path = `uploads/${Date.now()}_${file.name}`;
                            const url = await handleFileUpload(file, path);
                            updates.image = url; // Override URL
                        } catch (e) {
                            alert("Upload Error: " + e.message);
                            saveBtn.innerText = "Save";
                            saveBtn.disabled = false;
                            return; // Stop save
                        }
                    }

                    // Call actual save logic
                    await saveItem(mode, type, idOrParentId, updates, currentEdit.item);
                    closeEditModal();
                };
            }

            async function saveItem(mode, type, idOrParentId, updates, existingItem) {
                const saveBtn = document.getElementById('edit-save-btn');
                saveBtn.innerText = "Saving...";

                try {
                    // DB Updates
                    let collection = '';
                    if (type === 'category') collection = 'categories';
                    else if (type === 'subcategory') collection = 'subcategories';
                    else if (type === 'product') collection = 'products';
                    else if (type === 'news') collection = 'news'; // if unified

                    // Construct Data Object
                    const data = { ...updates };

                    if (mode === 'create') {
                        // Add parent references
                        if (type === 'subcategory') data.category_id = idOrParentId;
                        if (type === 'product') {
                            // Need subcat and cat id. 
                            // For simplicity, we assume idOrParentId is subCategory ID (as passed from renderProducts)
                            data.subcategory_id = idOrParentId;
                            // We might need to fetch category_id if strictly required by schema, 
                            // but for now let's assume subcategory_id is enough for relational fetch or we fetch it.
                            // Optimization: find subcategory to get category_id
                            const subRef = await db.collection('subcategories').doc(idOrParentId).get();
                            if (subRef.exists) data.category_id = subRef.data().category_id;
                        }
                        if (type === 'category') {
                            data.color = 'bg-blue-500';
                            data.icon_name = 'package';
                        }

                        await db.collection(collection).add(data);
                    } else {
                        // Update
                        if (existingItem && existingItem.id) {
                            await db.collection(collection).doc(existingItem.id).update(data);
                        }
                    }

                    showToast("Saved Successfully!");
                    loadData(); // Reload UI
                } catch (e) {
                    console.error("Save Error", e);
                    alert("Failed to save: " + e.message);
                } finally {
                    saveBtn.disabled = false;
                }
            }

        }

        async function deleteItem(type, id) {
            if (!confirm("Are you sure you want to delete this item?")) return;
            let table = type === 'category' ? 'categories' : (type === 'subcategory' ? 'subcategories' : 'products');
            const { error } = await window.supabase.from(table).delete().eq('id', id);
            if (error) { alert("Error deleting"); }
            else { showToast("Deleted"); loadData(); }
        }

        function getProductById(id) {
            for (let c of categories) {
                for (let s of c.subcategories) {
                    const p = s.products.find(p => p.id === id);
                    if (p) return p;
                }
            }
            return null;
        }

        function addToCart(productId) {
            const product = getProductById(productId);
            if (!product) return;

            const existing = state.cart.find(i => i.product.id === productId);
            if (existing) {
                existing.quantity++;
            } else {
                state.cart.push({ product, quantity: 1 });
            }
            // Show toast or feedback
            const btn = document.activeElement;
            if (btn && btn.tagName === 'BUTTON') {
                const originalText = btn.innerText;
                btn.innerText = 'Added!';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove('bg-green-600');
                }, 1000);
            }
            updateUI();
        }

        function removeFromCart(productId) {
            state.cart = state.cart.filter(i => i.product.id !== productId);
            updateUI();
        }

        function updateQuantity(productId, change) {
            const item = state.cart.find(i => i.product.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) removeFromCart(productId);
                else updateUI();
            }
        }

        function openCategory(i) { state.selectedCategory = categories[i]; state.page = 'subcategories'; state.selectedSubcategory = null; updateUI(); }
        function openSubcategory(i) { state.selectedSubcategory = state.selectedCategory.subcategories[i]; state.page = 'products'; updateUI(); }
        function goBack() {
            if (state.page === 'products') { state.page = 'subcategories'; state.selectedSubcategory = null; }
            else if (state.page === 'subcategories') { state.page = 'home'; state.selectedCategory = null; }
            updateUI();
        }

        function nextSlide() {
            const slides = document.querySelectorAll('.hero-slide');
            if (slides.length === 0) return;

            slides[state.currentSlide].classList.remove('active');
            slides[state.currentSlide].classList.add('exit');

            state.currentSlide = (state.currentSlide + 1) % heroSlides.length;

            setTimeout(() => {
                slides.forEach(s => s.classList.remove('exit'));
                slides[state.currentSlide].classList.add('active');
                updateCarouselIndicators();
            }, 100);
        }

        function goToSlide(index) {
            const slides = document.querySelectorAll('.hero-slide');
            if (slides.length === 0) return;

            slides[state.currentSlide].classList.remove('active');
            slides[state.currentSlide].classList.add('exit');

            state.currentSlide = index;

            setTimeout(() => {
                slides.forEach(s => s.classList.remove('exit'));
                slides[state.currentSlide].classList.add('active');
                updateCarouselIndicators();
            }, 100);
        }

        function updateCarouselIndicators() {
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach((ind, i) => {
                if (i === state.currentSlide) {
                    ind.classList.add('active');
                } else {
                    ind.classList.remove('active');
                }
            });
        }

        function startCarousel() {
            stopCarousel();
            carouselInterval = setInterval(nextSlide, 4000);
        }

        function stopCarousel() {
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }
        }

        function navigateTo(page, params = {}) {
            // Reset states
            if (page === 'home' || page === 'categories' || page === 'cart' || page === 'chat' || page === 'news' || page === 'new-products') {
                state.selectedCategory = null;
                state.selectedSubcategory = null;
                state.activeChat = null;
                state.activeChatUserName = null;
            }

            state.page = page;

            if (page === 'chat-thread') {
                state.activeChat = params.chatId;
                if (params.userName) state.activeChatUserName = params.userName;
            }

            updateUI();
        }

        function handleSearch(e) {
            state.searchQuery = e.target.value.toLowerCase();
            if (state.searchQuery.length > 0) {
                navigateTo('search-results');
            } else if (state.page === 'search-results') {
                navigateTo('home');
            }
        }

        async function createOrder() {
            if (state.cart.length === 0) return;
            if (!currentUser) {
                alert("Please login to place an order");
                navigateTo('profile');
                return;
            }

            const orderText = `New Order Request:\n\n${state.cart.map(i => `- ${i.product.name} (x${i.quantity}) @ ${i.product.price}`).join('\n')}\n\nTotal Items: ${state.cart.reduce((a, b) => a + b.quantity, 0)}`;

            try {
                // 1. Create Order using Firestore
                await db.collection('orders').add({
                    items: state.cart,
                    user_email: currentUser.email,
                    user_id: currentUser.uid,
                    status: 'pending',
                    created_at: new Date().toISOString()
                });

                // 2. Start Chat or Get Existing using Firestore
                let chatId;
                const chatQuery = await db.collection('chats')
                    .where('user_id', '==', currentUser.uid)
                    .limit(1)
                    .get();

                if (!chatQuery.empty) {
                    chatId = chatQuery.docs[0].id;
                } else {
                    const newChatRef = await db.collection('chats').add({
                        user_id: currentUser.uid,
                        user_name: currentUser.name,
                        admin_ids: adminEmails,
                        last_message: 'Order Request placed',
                        last_message_time: new Date().toISOString(),
                        unread_admin: 1,
                        unread_client: 0
                    });
                    chatId = newChatRef.id;
                }

                // 3. Send Message
                await db.collection('messages').add({
                    chat_id: chatId,
                    text: orderText,
                    sender_id: currentUser.uid,
                    sender_name: currentUser.name,
                    timestamp: new Date().toISOString(),
                    type: 'order'
                });

                // Update Chat metadata
                await db.collection('chats').doc(chatId).update({
                    last_message: 'New Order Request',
                    last_message_time: new Date().toISOString(),
                    unread_admin: firebase.firestore.FieldValue.increment(1)
                });


                state.cart = [];
                navigateTo('chat-thread', { chatId: chatId });
                console.log('Order created and chat started');

            } catch (err) {
                console.error('Order Error', err);
                alert('Failed to place order: ' + err.message);
            }
        }


        function renderHeader() {
            const header = document.getElementById('header');
            if (!header) return;

            // Don't show search bar on some pages or just keep it simple
            const showSearch = state.page === 'home' || state.page === 'search-results';

            header.innerHTML = `
            <div class="flex items-center gap-3 px-4 py-3">
               ${state.page !== 'home' ? `<button onclick="window.history.back()" class="p-1 -ml-2 text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>` : `<div class="font-bold text-xl tracking-tight text-pharmeasy-teal">Glo-Med</div>`}
               
               ${showSearch ? `
                <div class="flex-1 relative">
                     <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                     <input type="text" 
                            value="${state.searchQuery}"
                            oninput="handleSearch(this.value)"
                            placeholder="Search..." 
                            class="w-full bg-gray-50 border-none rounded-full py-2.5 pl-9 pr-4 text-sm focus:ring-1 focus:ring-pharmeasy-teal transition-all placeholder:text-gray-400">
                </div>
               ` : '<div class="flex-1"></div>'}

               <div class="flex items-center gap-2">
                   ${currentUser && currentUser.role === 'admin' ? `
                       <button onclick="navigateTo('orders')" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full relative">
                           <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                           ${orders.length > 0 ? `<div class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></div>` : ''}
                       </button>
                   ` : ''}
                    <button onclick="navigateTo('profile')" class="w-9 h-9 rounded-full overflow-hidden border border-gray-200 flex items-center justify-center">
                         ${currentUser && currentUser.photoURL ? `<img src="${currentUser.photoURL}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-5 h-5 text-gray-500"></i>`}
                    </button>
               </div>
            </div>`;
        }



        function showToast(message) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-[70] flex flex-col gap-2 w-full max-w-sm px-4';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = 'bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center justify-between animate-in fade-in slide-in-from-top-4 duration-300';
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="bell" class="w-4 h-4 text-pharmeasy-teal"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.add('animate-out', 'fade-out', 'slide-out-to-top-2');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function renderHome() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            const safeCategories = categories || [];
            const safeHeroSlides = heroSlides || [];

            // Safety check for flash deals product
            const flashDealProducts = safeCategories[0]?.subcategories?.[0]?.products || [];

            document.getElementById('main-content').innerHTML = `
            <div class="p-4 space-y-5">
                <div class="hero-carousel">
                    ${safeHeroSlides.map((slide, i) => `
                    <div class="hero-slide ${i === 0 ? 'active' : ''}">
                        <div class="absolute inset-0">
                            <img src="${slide.image}" class="w-full h-full object-cover rounded-2xl">
                        </div>
                        <div class="gradient-overlay rounded-2xl"></div>
                        <div class="relative z-10 h-full flex flex-col justify-end p-6 bg-gradient-to-t from-black/80 via-black/30 to-transparent rounded-2xl">
                            <div>
                                <h2 class="text-2xl font-bold text-white mb-1">${slide.title}</h2>
                                <p class="text-white/90 text-sm mb-1">${slide.subtitle}</p>
                            </div>
                        </div>
                    </div>`).join('')}
                    <div class="carousel-indicators">
                        ${safeHeroSlides.map((_, i) => `<div class="indicator ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></div>`).join('')}
                    </div>
                </div>

                <div id="categories-section">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="section-title">Shop by Category</h2>
                        ${isAdmin ? `<button onclick="openEditModal('create', 'category')" class="text-xs bg-pharmeasy-teal text-white px-3 py-1.5 rounded-full font-bold shadow-sm flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Add</button>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-3 auto-rows-min">
                        ${safeCategories.map((c, i) => {
                // Pattern: 0=Wide, 1=Small(L), 2=Tall(R), 3=Small(L)
                const mod = i % 4;
                let gridClass = '';
                let heightClass = '';

                if (mod === 0) {
                    gridClass = 'col-span-1';
                    heightClass = 'h-40';
                } else if (mod === 1) {
                    gridClass = 'col-span-1 row-span-2';
                    heightClass = 'h-full min-h-[calc(10rem+0.75rem+10rem)]';
                } else if (mod === 2) {
                    gridClass = 'col-span-1';
                    heightClass = 'h-40';
                } else { // mod === 3
                    gridClass = 'col-span-2';
                    heightClass = 'h-48 sm:h-64';
                }

                return `
                            <div class="relative group ${gridClass}">
                                <div onclick="openCategory(${i})" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer active:scale-[0.98] transition-all flex flex-col ${heightClass}">
                                    <div class="w-full h-full relative">
                                        <img src="${c.image}" alt="${c.name}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent"></div>
                                        
                                        ${mod === 3 ? `
                                        <div class="absolute inset-0 flex items-center justify-center">
                                             <div class="bg-white/90 backdrop-blur-sm px-6 py-2 rounded-sm shadow-sm">
                                                <h3 class="font-bold text-gray-900 uppercase tracking-widest text-sm">${c.name}</h3>
                                             </div>
                                        </div>`
                        :
                        `<div class="absolute bottom-4 left-0 right-0 text-center px-2">
                                             <div class="inline-block bg-white/95 backdrop-blur-sm px-4 py-1.5 rounded-sm shadow-sm">
                                                <h3 class="font-bold text-gray-900 uppercase tracking-wider text-[10px]">${c.name}</h3>
                                             </div>
                                        </div>`
                    }
                                    </div>
                                </div>
                                ${isAdmin ? `
                                <div class="absolute top-2 right-2 flex gap-2 z-10 w-fit">
                                    <button onclick="openEditModal('edit', 'category', '${c.id || i}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-blue-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button onclick="deleteItem('category', '${c.id}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>` : ''}
                            </div>`;
            }).join('')}
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="bg-pharmeasy-orange p-2 rounded-lg">
                                <i data-lucide="trending-up" class="w-4 h-4 text-white"></i>
                            </div>
                            <h2 class="section-title">Trending Products</h2>
                        </div>
                        <button class="text-pharmeasy-teal text-sm font-semibold">See All</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        ${flashDealProducts.slice(0, 4).map(p => `
                        <div class="bg-white rounded-lg overflow-hidden pb-2 group" onclick="addToCart('${p.id}')">
                            <div class="relative aspect-[4/5] bg-gray-100">
                                <img src="${p.image}" alt="${p.name}" class="w-full h-full object-cover">
                                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-sm">SALE</div>
                            </div>
                            <div class="mt-2 px-1">
                                <h3 class="text-sm text-gray-700 line-clamp-1 mb-0.5">${p.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-base font-bold text-gray-900">${p.price}</span>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>`;

            // Start carousel after rendering
            setTimeout(() => {
                startCarousel();
            }, 100);
        }

        function renderSearchResults() {
            const query = state.searchQuery;
            let results = [];
            (categories || []).forEach(cat => {
                (cat.subcategories || []).forEach(sub => {
                    (sub.products || []).forEach(p => {
                        if (p.name.toLowerCase().includes(query) || sub.name.toLowerCase().includes(query)) {
                            results.push(p);
                        }
                    });
                });
            });

            document.getElementById('main-content').innerHTML = `
                <div class="p-4">
                    <h3 class="font-bold text-gray-900 mb-4">Search Results for "${query}"</h3>
                ${results.length === 0 ? '<p class="text-gray-500">No products found.</p>' :
                    `<div class="grid grid-cols-2 gap-3">
                    ${results.map(p => `<div class="product-card"><div class="p-3"><div class="relative rounded-lg overflow-hidden h-40 mb-2"><img src="${p.image}" alt="${p.name}" class="w-full h-full object-cover"></div><h3 class="product-name mb-1 line-clamp-2 h-9">${p.name}</h3><div class="mb-3"><div class="price-current">${p.price}</div></div><button onclick="addToCart('${p.id}')" class="w-full pharmeasy-btn text-xs">Add to Cart</button></div></div>`).join('')}
                </div>`}
            </div>`;
        }

        function renderSubcategories() {
            if (!state.selectedCategory) return;
            const isAdmin = currentUser && currentUser.role === 'admin';
            const subcategories = state.selectedCategory.subcategories || [];

            document.getElementById('main-content').innerHTML = `
                <div class="p-4">
                    ${isAdmin ? `
                <div onclick="openEditModal('create', 'subcategory', '${state.selectedCategory.id}')" class="mb-4 bg-white border-2 border-dashed border-gray-300 rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-pharmeasy-teal hover:bg-teal-50 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2">
                        <i data-lucide="plus" class="w-6 h-6 text-gray-500"></i>
                    </div>
                    <span class="text-sm font-bold text-gray-600">Add New Collection</span>
                </div>` : ''
                }

            <div class="space-y-3">
                ${subcategories.length === 0 ? '<p class="text-center text-gray-500 py-10">No collections yet.</p>' :
                    subcategories.map((s, i) => `
                    <div class="relative group">
                        <div onclick="openSubcategory(${i})" class="pharmeasy-card overflow-hidden cursor-pointer active:scale-95">
                            <div class="relative h-40 overflow-hidden">
                                <img src="${s.image}" alt="${s.name}" class="category-image">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 right-0 p-4">
                                    <div class="flex items-center justify-between">
                                        <div><p class="text-lg font-bold text-white mb-1">${s.name}</p></div>
                                        <div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg"><i data-lucide="chevron-right" class="w-5 h-5 text-white"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="absolute top-2 right-2 flex gap-2 z-10">
                            <button onclick="openEditModal('edit', 'subcategory', '${s.id || s.name}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-blue-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="deleteItem('subcategory', '${s.id}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>` : ''}
                    </div>`).join('')}
            </div>
            </div>`;
        }


        function renderProducts() {
            if (!state.selectedSubcategory) return;
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.getElementById('main-content').innerHTML = `
                <div class="p-3">
                    ${isAdmin ? `
                <div onclick="openEditModal('create', 'product', '${state.selectedSubcategory.id}')" class="mb-4 bg-white border-2 border-dashed border-gray-300 rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-pharmeasy-teal hover:bg-teal-50 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mb-2">
                        <i data-lucide="plus" class="w-6 h-6 text-gray-500"></i>
                    </div>
                    <span class="text-sm font-bold text-gray-600">Add New Product</span>
                </div>` : ''
                }

            <div class="grid grid-cols-2 gap-3">
                ${(state.selectedSubcategory.products || []).map(p => `
                    <div class="bg-white rounded-lg overflow-hidden pb-2 group" onclick="addToCart('${p.id}')">
                        <div class="relative aspect-[4/5] bg-gray-100">
                            <img src="${p.image}" alt="${p.name}" class="w-full h-full object-cover">
                            
                            <!-- Sale Badge -->
                            ${p.discount || p.original_price ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-sm">SALE</div>` : ''}

                            ${isAdmin ? `
                            <div class="absolute top-2 left-2 flex flex-col gap-2 z-10" onclick="event.stopPropagation()">
                                <button onclick="openEditModal('edit', 'product', '${p.id}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-blue-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                <button onclick="deleteItem('product', '${p.id}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>` : ''}
                        </div>
                        
                        <div class="mt-2 px-1">
                            <h3 class="text-sm text-gray-700 line-clamp-1 mb-0.5">${p.name}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-base font-bold text-gray-900">${p.price}</span>
                            </div>
                        </div>
                    </div>`).join('')}
            </div>
            </div>`;
        }


        function renderCart() {
            const h = document.getElementById('main-content');
            if (state.cart.length === 0) {
                h.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-6 text-center"><div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4"><i data-lucide="shopping-cart" class="w-10 h-10 text-gray-400"></i></div><h3 class="text-lg font-bold text-gray-900 mb-2">Your Cart is Empty</h3><p class="text-gray-500 text-sm mb-6">Looks like you haven't added any medical supplies yet.</p><button onclick="navigateTo('home')" class="pharmeasy-btn w-48">Start Shopping</button></div>`;
                return;
            }

            h.innerHTML = `<div class="p-4 pb-24"><div class="space-y-4">${state.cart.map(item => `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3">
                    <img src="${item.product.image}" class="w-20 h-20 bg-gray-100 rounded-lg object-cover">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                             <h4 class="text-sm font-semibold text-gray-900 line-clamp-2">${item.product.name}</h4>
                             <button onclick="removeFromCart('${item.product.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">${item.product.company}</p>
                        <div class="flex items-center justify-between mt-2">
                             <div class="price-current">${item.product.price}</div>
                             <div class="flex items-center gap-3 bg-gray-50 rounded-lg px-2 py-1">
                                 <button onclick="updateQuantity('${item.product.id}', -1)" class="text-gray-600 font-bold">-</button>
                                 <span class="text-sm font-medium text-gray-900">${item.quantity}</span>
                                 <button onclick="updateQuantity('${item.product.id}', 1)" class="text-pharmeasy-teal font-bold">+</button>
                             </div>
                        </div>
                    </div>
                </div>`).join('')}
            </div>
            
             <div class="fixed bottom-[70px] left-0 right-0 bg-white border-t border-gray-100 p-4 max-w-md mx-auto">
                <button onclick="createOrder()" class="w-full pharmeasy-btn py-3 text-base shadow-lg shadow-teal-700/20">Order Now</button>
             </div>
            </div> `;
        }

        async function updateOrderStatus(id, status) {
            if (!confirm(`Mark order as ${status}?`)) return;
            try {
                await db.collection('orders').doc(id).update({ status });
                showToast(`Order marked as ${status} `);
                loadData(); // Reload orders
            } catch (e) {
                console.error(e);
                alert("Error updating order");
            }
        }

        function renderOrders() {
            if (!currentUser || currentUser.role !== 'admin') return navigateTo('home');

            document.getElementById('main-content').innerHTML = `
                <div class="p-4 space-y-4">
                    ${orders.length === 0 ? '<div class="text-center py-10 text-gray-500">No orders yet</div>' :
                    orders.map(o => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${o.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : (o.status === 'shipped' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700')} uppercase tracking-wide">${o.status || 'Pending'}</span>
                            <p class="text-xs text-gray-500 mt-1">${new Date(o.created_at).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-900">${o.user_email}</p>
                            <p class="text-xs text-gray-500">ID: #${o.id}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${(o.items || []).map(i => `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">${i.quantity}x ${i.product.name}</span>
                            <span class="font-medium">${i.product.price}</span>
                        </div>`).join('')}
                    </div>
                    
                    ${o.status !== 'delivered' ? `
                    <div class="flex gap-2 border-t pt-3">
                        ${o.status === 'pending' ? `
                        <button onclick="updateOrderStatus('${o.id}', 'shipped')" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors">Mark Shipped</button>` : ''}
                        ${o.status === 'shipped' || o.status === 'pending' ? `
                        <button onclick="updateOrderStatus('${o.id}', 'delivered')" class="flex-1 bg-green-50 text-green-600 py-2 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors">Mark Delivered</button>` : ''}
                    </div>` : ''}
                </div>`).join('')
                }
            </div>`;
        }

        function renderChat() {
            // Guest Chat Logic: Allow guests to chat with support locally or prompted name
            if (!currentUser) {
                // Fallback for guests - show a simple "Start Chat as Guest"
                document.getElementById('main-content').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-6 text-center">
                     <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4">
                         <i data-lucide="message-circle" class="w-10 h-10 text-green-500"></i>
                     </div>
                     <h3 class="text-lg font-bold text-gray-900 mb-2">WhatsApp Support</h3>
                     <p class="text-gray-500 text-sm mb-6">Chat with us instantly, even as a guest!</p>
                     <button onclick="document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal-title').innerText='Enter Name to Chat'; document.getElementById('edit-modal-content').innerHTML='<input id=\\'guest-name\\' class=\\'w-full border p-2 rounded\\' placeholder=\\'Your Name\\'>'; document.getElementById('edit-save-btn').onclick=startGuestChat;" class="bg-green-500 text-white rounded-full px-8 py-3 font-bold shadow-lg">Start Chat</button>
                 </div>`;
                return;
            }

            const isUserAdmin = currentUser.role === 'admin';

            document.getElementById('main-content').innerHTML = `
                <div class="bg-white min-h-screen">
                <div class="bg-white p-4 border-b border-gray-100 flex items-center justify-between sticky top-0 z-10">
                    <h2 class="text-xl font-bold text-green-600">Chats</h2>
                    ${!isUserAdmin ? `
                    <button onclick="startNewChat()" class="text-green-600 font-medium text-sm flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> New
                    </button>
                    ` : ''}
                </div>

                <div class="divide-y divide-gray-100">
                    ${chats.length === 0 ? `
                        <div class="text-center py-20 text-gray-400">
                            <p>No messages yet</p>
                        </div>
                    ` : ''}
                    ${chats.map(chat => `
                    <div onclick="navigateTo('chat-thread', {chatId: '${chat.id}', userName: '${chat.userName || 'User'}'})" class="chat-row flex items-center gap-3 p-4 hover:bg-gray-50 cursor-pointer">
                        <div class="relative">
                            <img src="${chat.avatar || 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=100&h=100&fit=crop'}" class="w-12 h-12 rounded-full object-cover">
                            ${chat.unread > 0 ? `<div class="absolute -top-1 -right-1 bg-green-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white font-bold">${chat.unread}</div>` : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-1">
                                <h4 class="font-semibold text-gray-900 text-base truncate">${isUserAdmin ? chat.userName : 'Support Team'}</h4>
                                <span class="text-[10px] text-gray-400 whitespace-nowrap">${chat.time}</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate mt-0.5 flex items-center gap-1">
                                ${chat.lastMessage || 'Image/File'}
                            </p>
                        </div>
                    </div>
                    `).join('')}
                </div>
             </div>`;
        }

        async function startGuestChat() {
            const name = document.getElementById('guest-name').value;
            if (!name) return;
            // Mock a user for session
            currentUser = { uid: 'guest-' + Date.now(), name: name, role: 'user', email: 'guest@glo.med' };
            closeEditModal();
            startNewChat();
        }

        async function startNewChat() {
            // Logic to start chat 
            if (!currentUser) return;

            try {
                // Check existing
                const existingChatsSnap = await db.collection('chats')
                    .where('user_id', '==', currentUser.uid)
                    .limit(1)
                    .get();

                if (!existingChatsSnap.empty) {
                    navigateTo('chat-thread', { chatId: existingChatsSnap.docs[0].id });
                    return;
                }

                // Create new
                const docRef = await db.collection('chats').add({
                    user_id: currentUser.uid,
                    user_name: currentUser.name,
                    admin_ids: adminEmails,
                    last_message: 'Chat started',
                    last_message_time: new Date().toISOString(),
                    unread_admin: 1,
                    unread_client: 0,
                    created_at: new Date().toISOString()
                });

                navigateTo('chat-thread', { chatId: docRef.id });
            } catch (error) {
                console.error("Start Chat Error", error);
                alert("Failed to start chat");
            }
        }


        let currentMessages = [];

        function renderChatThread() {
            const chatId = state.activeChat;
            if (!chatId) return;
            const isUserAdmin = currentUser ? currentUser.role === 'admin' : false;

            // Subscribe logic reused...
            if (messagesUnsubscribe) { messagesUnsubscribe(); messagesUnsubscribe = null; }

            // Render Container with WhatsApp BG
            document.getElementById('main-content').innerHTML = `
                <div class="flex flex-col h-full relative bg-[#e5ddd5]" style = "background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');" >
                 
                 <!--Chat Header-->
                 <div class="bg-white p-3 flex items-center gap-3 sticky top-0 shadow-sm z-20">
                    <button onclick="navigateTo('${isUserAdmin ? 'chat' : 'home'}')" class="text-green-600"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                        <img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=100&h=100&fit=crop" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-900">${isUserAdmin ? state.activeChatUserName || 'User' : 'Support Team'}</h3>
                        <p class="text-xs text-green-500">Online</p>
                    </div>
                 </div>

                 <div id="messages-container" class="flex-1 p-4 space-y-2 overflow-y-auto pb-20">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                    </div>
                 </div>
                 
                 <!-- WhatsApp Style Bottom Bar -->
                 <div class="fixed bottom-0 left-0 right-0 bg-gray-50 px-2 py-2 flex items-end gap-2 border-t border-gray-200 z-50 max-w-md mx-auto">
                     <button onclick="document.getElementById('chat-file-input').click()" class="p-3 text-gray-500 hover:bg-gray-200 rounded-full mb-0.5 transition-colors">
                         <i data-lucide="plus" class="w-6 h-6"></i>
                     </button>
                     <input type="file" id="chat-file-input" class="hidden" accept="image/*" onchange="handleChatImageSelect(this)">
                     
                     <div class="flex-1 bg-white rounded-2xl flex items-center border border-gray-200 shadow-sm min-h-[48px] px-4 py-2 focus-within:ring-1 focus-within:ring-green-500 focus-within:border-green-500 transition-all">
                         <input type="text" id="message-input" onkeypress="if(event.key === 'Enter') sendMessage()" placeholder="Message" class="w-full border-none focus:ring-0 text-base bg-transparent p-0 max-h-32 placeholder:text-gray-400">
                     </div>
                     
                     <button onclick="sendMessage()" class="p-3 bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 mb-0.5 transition-all active:scale-95 flex items-center justify-center">
                         <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                     </button>
                 </div>
             </div> `;

            // Firestore Realtime Listener
            messagesUnsubscribe = db.collection('messages')
                .where('chat_id', '==', chatId)
                // .orderBy('timestamp', 'asc') // Removed to prevent index errors
                .onSnapshot(snapshot => {
                    const rawMessages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp ? new Date(doc.data().timestamp) : null,
                        senderId: doc.data().sender_id
                    }));
                    // Client-side sort
                    currentMessages = rawMessages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

                    updateChatThreadUI();
                }, error => {
                    console.error("Msg Subscription Error", error);
                    const container = document.getElementById('messages-container');
                    if (container) container.innerHTML = `<div class="p-4 text-center text-red-500 text-xs">Failed to load messages. Please ensure indices are created or check console.</div>`;
                });

            // Reset unread
            const updateObj = isUserAdmin ? { unread_admin: 0 } : { unread_client: 0 };
            db.collection('chats').doc(chatId).update(updateObj).catch(console.error);
        }

        async function fetchMessages(chatId) {
            // No-op, handled by subscription
        }

        function updateChatThreadUI() {
            const container = document.getElementById('messages-container');
            if (!container) return;

            if (currentMessages.length === 0) {
                container.innerHTML = `<div class="bg-[#dcf8c6] rounded-lg p-2 text-xs text-center mx-auto shadow-sm max-w-[200px] mt-4" > Messages are end - to - end encrypted.No one outside of this chat, not even WhatsApp, can read or listen to them.</div> `;
                return;
            }

            container.innerHTML = currentMessages.map(m => {
                const isMe = m.senderId === currentUser.uid;
                const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}" >
                    <div class="${isMe ? 'chat-bubble-mine' : 'chat-bubble-theirs'} px-3 py-1.5 max-w-[80%] shadow-sm text-sm relative group">
                        ${m.type === 'image' ?
                        `<img src="${m.image}" class="rounded-lg mb-1 max-w-[200px] cursor-pointer" onclick="window.open('${m.image}', '_blank')">`
                        : `<p class="mr-12 mb-1 text-gray-900">${m.text}</p>`
                    }
                        <span class="text-[10px] text-gray-500 absolute bottom-1 right-2 flex items-center gap-0.5">
                            ${time}
                            ${isMe ? '<i data-lucide="check-check" class="w-3 h-3 text-blue-500"></i>' : ''}
                        </span>
                    </div>
                </div>
                `;
            }).join('');
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const chatId = state.activeChat;
            if (!chatId) return;

            input.value = ''; // Clear locally

            try {
                // Add message to Firestore
                await db.collection('messages').add({
                    chat_id: chatId,
                    text: text,
                    type: 'text',
                    sender_id: currentUser.uid,
                    sender_name: currentUser.name,
                    timestamp: new Date().toISOString()
                });

                // Update chat metadata
                const isUserAdmin = currentUser.role === 'admin';
                const updateData = {
                    last_message: text,
                    last_message_time: new Date().toISOString(),
                    unread_admin: isUserAdmin ? 0 : 1,
                    unread_client: isUserAdmin ? 1 : 0
                };

                await db.collection('chats').doc(chatId).update(updateData);

            } catch (e) {
                console.error("Send Error", e);
                alert("Failed to send");
            }
        }


        function renderNews() {
            const isAdmin = currentUser && currentUser.role === 'admin';

            document.getElementById('main-content').innerHTML = `
                <div class="bg-white">
                 <div class="p-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10">
                    <h2 class="text-xl font-bold text-gray-900">News & Updates</h2>
                     ${isAdmin ? `<button onclick="openEditModal('create', 'news')" class="text-xs bg-pharmeasy-teal text-white px-3 py-1.5 rounded-full font-bold shadow-sm flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Add Post</button>` : ''}
                </div>
                <div class="p-4 space-y-6 mb-20">
                ${newsPosts.map((post, i) => `
                <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 relative group">
                    <div class="flex items-center p-3 gap-3">
                        <div class="w-10 h-10 rounded-full bg-pharmeasy-teal/10 flex items-center justify-center">
                            <i data-lucide="${post.type === 'video' ? 'play-circle' : 'image'}" class="w-5 h-5 text-pharmeasy-teal"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900 text-sm">${post.title}</h3>
                            <p class="text-xs text-gray-500">${post.time} â€¢ ${post.views} views</p>
                        </div>
                         ${isAdmin ? `
                        <div class="absolute top-3 right-3 flex gap-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openEditModal('edit', 'news', '${i}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-blue-600"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="deleteItem('news', '${i}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>` : ''}
                    </div>
                    
                    <div class="relative w-full h-48 bg-gray-100">
                         <img src="${post.image}" class="w-full h-full object-cover">
                         ${post.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black/20"><div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center pl-1"><i data-lucide="play" class="w-6 h-6 text-pharmeasy-teal fill-current"></i></div></div>` : ''}
                    </div>

                    <div class="p-3">
                        <p class="text-gray-600 text-sm leading-relaxed">${post.description}</p>
                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-100">
                            <button onclick="toggleLike(this)" class="flex items-center gap-1.5 text-gray-500 hover:text-pharmeasy-teal transition-colors">
                                <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                                <span class="text-xs font-medium">Like</span>
                            </button>
                            <button onclick="toggleDislike(this)" class="flex items-center gap-1.5 text-gray-500 hover:text-red-500 transition-colors">
                                <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                                <span class="text-xs font-medium">Dislike</span>
                            </button>
                            <button class="flex items-center gap-1.5 text-gray-500 hover:text-pharmeasy-teal transition-colors ml-auto">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                                <span class="text-xs font-medium">Share</span>
                            </button>
                        </div>
                    </div>
                </div>
                `).join('')}
                </div>
            </div > `;
        }

        function toggleLike(btn) {
            btn.classList.toggle('text-pharmeasy-teal');
            const icon = btn.querySelector('i');
            if (btn.classList.contains('text-pharmeasy-teal')) {
                icon.classList.add('fill-current');
            } else {
                icon.classList.remove('fill-current');
            }
        }

        function toggleDislike(btn) {
            btn.classList.toggle('text-red-500');
            const icon = btn.querySelector('i');
            if (btn.classList.contains('text-red-500')) {
                icon.classList.add('fill-current');
            } else {
                icon.classList.remove('fill-current');
            }
        }



        function renderCategories() {
            // Bento Grid Layout (Hero + Split Layout)
            const isAdmin = currentUser && currentUser.role === 'admin';
            const safeCategories = categories || [];

            document.getElementById('main-content').innerHTML = `
                <div class="p-3 pb-24">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-gray-900">All Categories</h2>
                    ${isAdmin ? `<button onclick="openEditModal('create', 'category')" class="text-xs bg-pharmeasy-teal text-white px-3 py-1.5 rounded-full font-bold shadow-sm flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Add</button>` : ''}
                </div>
                
                <div class="space-y-4">
                    ${safeCategories.map((c, i) => `
                    <div class="relative group">
                        <div onclick="openCategory(${i})" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer active:scale-[0.99] transition-all flex flex-col h-48">
                            <div class="w-full h-full relative">
                                <img src="${c.image}" alt="${c.name}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                                
                                <div class="absolute bottom-0 left-0 right-0 p-5">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-2xl font-bold text-white mb-1 shadow-black/20 drop-shadow-md">${c.name}</h3>
                                            <p class="text-white/80 text-sm font-medium flex items-center gap-1">
                                                <i data-lucide="layers" class="w-3 h-3"></i>
                                                ${c.subcategories ? c.subcategories.length : 0} Collections
                                            </p>
                                        </div>
                                        <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/20">
                                            <i data-lucide="arrow-right" class="w-5 h-5 text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="absolute top-2 right-2 flex gap-2 z-10">
                            <button onclick="openEditModal('edit', 'category', '${c.id || i}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-blue-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="deleteItem('category', '${c.id}')" class="p-1.5 bg-white/90 rounded-full shadow-sm hover:bg-white text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>` : ''}
                    </div>`).join('')}
                </div>
            </div> `;
        }

        function renderHeader() {
            const header = document.getElementById('header');
            if (!header) return;

            const showSearch = state.page === 'home' || state.page === 'search-results';
            const isRootPage = ['home', 'categories', 'news', 'cart', 'profile'].includes(state.page);

            header.innerHTML = `
                <div class="flex items-center gap-3 px-4 py-3">
                    ${!isRootPage ? `<button onclick="goBack()" class="p-1 -ml-2 text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>` : `<div class="font-bold text-xl tracking-tight text-pharmeasy-teal">Glo-Med</div>`}
               
               ${showSearch ? `
                <div class="flex-1 relative">
                     <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                     <input type="text" 
                            value="${state.searchQuery}"
                            oninput="handleSearch(this.value)"
                            placeholder="Search..." 
                            class="w-full bg-gray-50 border-none rounded-full py-2.5 pl-9 pr-4 text-sm focus:ring-1 focus:ring-pharmeasy-teal transition-all placeholder:text-gray-400">
                </div>
               ` : '<div class="flex-1"></div>'
                }

            <div class="flex items-center gap-2">
                ${currentUser && currentUser.role === 'admin' ? `
                       <button onclick="navigateTo('orders')" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full relative">
                           <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                           ${orders.length > 0 ? `<div class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></div>` : ''}
                       </button>
                   ` : ''}
                <button onclick="navigateTo('profile')" class="w-9 h-9 rounded-full overflow-hidden border border-gray-200 flex items-center justify-center">
                    ${currentUser && currentUser.photoURL ? `<img src="${currentUser.photoURL}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-5 h-5 text-gray-500"></i>`}
                </button>
            </div>
            </div> `;
        }

        function goBack() {
            if (state.page === 'products') {
                state.page = 'categories'; // Changed from 'subcategories' to 'categories'
                state.selectedSubcategory = null;
                state.selectedCategory = null; // Clear selected category too
            } else if (state.page === 'search-results') {
                state.page = 'home';
                state.searchQuery = '';
            } else if (['chat-thread', 'orders', 'news-post'].includes(state.page)) {
                state.page = 'home';
            } else {
                state.page = 'home';
            }
            updateUI();
        }

        // Helper to handle clicks on the sub items (previously logic existed for this)
        // Helper to handle clicks on the sub items
        function openSubcategory(i) {
            console.log("Opening Subcategory Index", i);
            if (state.selectedCategory && state.selectedCategory.subcategories) {
                state.selectedSubcategory = state.selectedCategory.subcategories[i];
                state.page = 'products';
                updateUI();
            } else {
                console.error("No selected category or subcategories found");
            }
        }

        function renderProfile() {
            const h = document.getElementById('main-content');
            if (currentUser) {
                // Logged In View
                h.innerHTML = `
                <div class="p-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col items-center mb-6">
                        <div class="w-24 h-24 rounded-full bg-pharmeasy-teal/10 flex items-center justify-center text-pharmeasy-teal text-3xl font-bold mb-4 overflow-hidden">
                            ${currentUser.photoURL ? `<img src="${currentUser.photoURL}" class="w-full h-full object-cover">` : currentUser.name.charAt(0)}
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">${currentUser.name}</h2>
                        <p class="text-sm text-gray-500 mb-2">${currentUser.email}</p>
                        ${currentUser.role === 'admin' ? '<span class="px-3 py-1 bg-pharmeasy-orange/10 text-pharmeasy-orange text-xs font-bold rounded-full border border-pharmeasy-orange/20">ADMIN</span>' : '<span class="px-3 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full">User</span>'}
                    </div>

                    ${currentUser.role === 'admin' ? `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                        <h3 class="font-bold text-gray-900 mb-3">Admin Actions</h3>
                        <button onclick="seedDatabase()" class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 transition-colors">
                             <i data-lucide="database" class="w-5 h-5 text-pharmeasy-teal"></i>
                             <span class="text-sm font-medium text-gray-700">Seed Database</span>
                        </button>
                    </div>
                    ` : ''
                    }

            <button onclick="logout()" class="w-full pharmeasy-btn bg-red-500 hover:bg-red-600 text-white">Log Out</button>
                </div> `;
            } else {
                // Login/Register View
                h.innerHTML = `
                <div class="p-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Welcome to Glo-Med</h2>

                        <div class="flex gap-4 mb-6 border-b border-gray-100">
                            <button onclick="document.getElementById('login-form').classList.remove('hidden'); document.getElementById('register-form').classList.add('hidden'); this.classList.add('text-pharmeasy-teal', 'border-b-2', 'border-pharmeasy-teal'); this.nextElementSibling.classList.remove('text-pharmeasy-teal', 'border-b-2', 'border-pharmeasy-teal');" class="flex-1 pb-3 font-semibold text-pharmeasy-teal border-b-2 border-pharmeasy-teal transition-all">Login</button>
                            <button onclick="document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); this.classList.add('text-pharmeasy-teal', 'border-b-2', 'border-pharmeasy-teal'); this.previousElementSibling.classList.remove('text-pharmeasy-teal', 'border-b-2', 'border-pharmeasy-teal');" class="flex-1 pb-3 font-semibold text-gray-400 transition-all">Register</button>
                        </div>

                        <!-- Login Form -->
                        <div id="login-form" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Email</label>
                                <input type="email" id="login-email" class="w-full pharmeasy-search px-4 py-3 text-sm" placeholder="Enter your email">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Password</label>
                                <input type="password" id="login-password" class="w-full pharmeasy-search px-4 py-3 text-sm" placeholder="Enter password">
                            </div>
                            <button onclick="login()" class="w-full pharmeasy-btn py-3 mt-2">Sign In</button>
                            <div class="relative py-2">
                                <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-100"></span></div>
                                <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-500">Or continue with</span></div>
                            </div>
                            <button onclick="googleLogin()" class="w-full bg-white border border-gray-200 text-gray-700 font-semibold py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 transition-all">
                                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" /><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" /><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05" /><path d="M12 4.66c1.61 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.19 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" /></svg>
                                Google
                            </button>

                            <!-- Temporary Debug Button -->
                            <div class="mt-8 pt-6 border-t border-gray-100">
                                <h3 class="text-center text-sm font-bold text-gray-400 uppercase mb-4">Developer Tools</h3>
                                <button onclick="seedDatabase()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-900 transition-all">
                                    <i data-lucide="database" class="w-5 h-5"></i>
                                    Seed Database Now
                                </button>
                                <p class="text-xs text-center text-gray-500 mt-2">Click this to upload data to Firebase without logging in.</p>
                            </div>
                        </div>

                        <!-- Register Form -->
                        <div id="register-form" class="space-y-4 hidden">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="reg-name" class="w-full pharmeasy-search px-4 py-3 text-sm" placeholder="Your name">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Email</label>
                                <input type="email" id="reg-email" class="w-full pharmeasy-search px-4 py-3 text-sm" placeholder="Enter your email">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Password</label>
                                <input type="password" id="reg-password" class="w-full pharmeasy-search px-4 py-3 text-sm" placeholder="Create password (min 6 chars)">
                            </div>
                            <button onclick="register()" class="w-full pharmeasy-btn py-3 mt-2">Create Account</button>
                        </div>
                    </div>
                </div> `;
            }
        }

        window.login = async function () {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                // Listener will update UI
            } catch (error) {
                alert("Login failed: " + error.message);
                console.error("Login Error:", error);
            }
        };

        window.register = async function () {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            if (!name) return alert("Name is required");

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                // Update profile
                await userCredential.user.updateProfile({
                    displayName: name
                });

                // Add to users collection using Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'user', // Default role
                    created_at: new Date().toISOString()
                });

                alert("Registration successful!");
            } catch (error) {
                alert("Registration failed: " + error.message);
                console.error("Registration Error:", error);
            }
        };

        window.googleLogin = async function () {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                alert("Google Login failed: " + error.message);
                console.error("Google Login Error:", error);
            }
        };

        window.logout = async function () {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout Error:", error);
            }
        };

        async function uploadChatImage(file) {
            const fileName = `chat_uploads/${Date.now()}_${currentUser.uid}_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const ref = storage.ref(fileName);
            await ref.put(file);
            return await ref.getDownloadURL();
        }

        async function handleChatImageSelect(input) {
            const file = input.files[0];
            if (!file) return;

            showToast("Uploading image...");

            try {
                const url = await uploadChatImage(file);
                await db.collection('messages').add({
                    chat_id: state.activeChat,
                    text: 'Sent an image',
                    image: url,
                    type: 'image',
                    sender_id: currentUser.uid,
                    sender_name: currentUser.name,
                    timestamp: new Date().toISOString()
                });

                // Update chat metadata
                await db.collection('chats').doc(state.activeChat).update({
                    last_message: 'ðŸ“· Image',
                    last_message_time: new Date().toISOString(),
                    unread_admin: currentUser.role === 'admin' ? 0 : firebase.firestore.FieldValue.increment(1),
                    unread_client: currentUser.role === 'admin' ? firebase.firestore.FieldValue.increment(1) : 0
                });
            } catch (e) {
                console.error(e);
                showToast("Failed to upload image");
            }
        }

        function handleAuthChange(user) {
            if (user) {
                const isAdmin = adminEmails.includes(user.email);
                currentUser = {
                    uid: user.uid,
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    photoURL: user.photoURL,
                    role: isAdmin ? 'admin' : 'user'
                };

                console.log("User logged in:", currentUser);
                if (state.page === 'profile') updateUI();
                subscribeToChats();
            } else {
                currentUser = null;
                console.log("User logged out");
                if (state.page === 'profile') updateUI();
                chats = [];
                if (chatsUnsubscribe) chatsUnsubscribe();
            }
        }

        // Auth Listener
        window.addEventListener('load', () => {
            // Init Auth Listener
            auth.onAuthStateChanged(user => {
                handleAuthChange(user);
                loadData();
            });
        });

        function updateUI() {
            if (state.page !== 'home') {
                stopCarousel();
            }

            // Cleanup message listener if leaving chat thread
            if (state.page !== 'chat-thread' && messagesUnsubscribe) {
                messagesUnsubscribe();
                messagesUnsubscribe = null;
            }

            renderHeader();
            if (state.page === 'home') renderHome();
            else if (state.page === 'categories') renderCategories();
            else if (state.page === 'subcategories') renderSubcategories();
            else if (state.page === 'products') renderProducts();
            else if (state.page === 'news' || state.page === 'new-products') renderNews();
            else if (state.page === 'search-results') renderSearchResults();
            else if (state.page === 'cart') renderCart();
            else if (state.page === 'chat') renderChat();
            else if (state.page === 'chat-thread') renderChatThread();
            else if (state.page === 'profile') renderProfile();
            renderBottomNav();
            lucide.createIcons();
            if (state.page !== 'home') document.getElementById('main-content').scrollTop = 0;
        }

        function renderBottomNav() {
            const nav = document.getElementById('bottom-nav');
            if (!nav) return;

            // Hide bottom nav in chat thread
            if (state.page === 'chat-thread') {
                nav.innerHTML = '';
                return;
            }

            const tabs = [
                { id: 'home', icon: 'home', label: 'Home' },
                { id: 'categories', icon: 'grid', label: 'Categories' }, // New Categories Tab
                { id: 'chat', icon: 'message-circle', label: 'Chat', customClass: 'text-green-500' }, // Green Chat Icon
                { id: 'cart', icon: 'shopping-cart', label: 'Cart', badge: state.cart.length },
                { id: 'news', icon: 'newspaper', label: 'News' } // News Tab instead of Profile
            ];

            nav.innerHTML = tabs.map(t => {
                const isActive = state.page === t.id || (t.id === 'categories' && state.page === 'subcategories');
                const colorClass = t.id === 'chat' ? 'text-green-500' : (isActive ? 'text-black' : 'text-gray-400');

                return `
                <div onclick="setPage('${t.id}')" class="nav-item ${isActive ? 'active' : ''} flex-1 flex flex-col items-center justify-center cursor-pointer relative">
                    <div class="relative">
                        <i data-lucide="${t.icon}" class="w-6 h-6 ${colorClass}"></i>
                        ${t.badge > 0 ? `<div class="cart-badge absolute -top-1 -right-2 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center">${t.badge}</div>` : ''}
                    </div>
                    <span class="text-[10px] mt-1 ${isActive ? 'font-bold text-black' : 'text-gray-500'}">${t.label}</span>
                </div >
                `;
            }).join('');

            lucide.createIcons();
        }

        // Helper for navigation
        window.setPage = function (page) {
            state.page = page;
            updateUI();
        };

        try {
            updateUI();
        } catch (e) {
            console.error(e);
            alert('App Start Error: ' + e.message);
        }

        // Seed Database Function (Stubbbed for Supabase)
        // Seed Database Function (Supabase)
        // Seed Database Function (Firebase)
        async function seedDatabase() {
            if (!confirm('This will upload current hardcoded categories and products to Firestore. Make sure you have created the database first. Continue?')) return;
            console.log('Starting seed process...');
            alert("Starting Seed Process... Check Console for progress.");

            try {
                const batch = db.batch(); // Use batch for cleaner atomic writes if possible, OR standard loop

                for (const cat of categories) {
                    // Create Category
                    const catRef = db.collection('categories').doc(); // Auto-ID
                    await catRef.set({
                        id: catRef.id, // Generate ID within doc for compatibility
                        name: cat.name,
                        image: cat.image,
                        color: cat.color,
                        icon_name: cat.iconName
                    });

                    console.log(`Created category: ${cat.name} `);

                    for (const sub of cat.subcategories) {
                        // Create Subcategory
                        const subRef = db.collection('subcategories').doc();
                        await subRef.set({
                            id: subRef.id,
                            name: sub.name,
                            image: sub.image,
                            category_id: catRef.id
                        });

                        // Create Products
                        for (const prod of sub.products) {
                            const prodRef = db.collection('products').doc();
                            await prodRef.set({
                                id: prodRef.id,
                                name: prod.name,
                                company: prod.company,
                                price: prod.price,
                                original_price: prod.originalPrice,
                                unit: prod.unit,
                                rating: prod.rating,
                                reviews: prod.reviews,
                                image: prod.image,
                                subcategory_id: subRef.id,
                                category_id: catRef.id,
                                discount: prod.discount || false
                            });
                        }
                        console.log(`    Inserted products for ${sub.name}`);
                    }
                }
                alert('Seeding completed! You can now browse your data in Firestore.');
            } catch (err) {
                console.error('Seed Error:', err);
                alert('Error during seeding: ' + err.message);
            }
        }

        // PWA Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered', reg))
                    .catch(err => console.log('SW Registration Failed', err));
            });
        }
    </script>
</body>

</html>